# SnailBaLL
A snail identification tool based on COI barcodes represented by RNA large language model.

This repository contains codes of **[SnailBaLL](), a deep learning model for genus-level identification of molluscan species, especially land snail within the order Stylommatophora**. SnailBaLL could test and predict whether two COI sequences are the same genus or not, by employing embeddings of the RNA secondary structure extracted using the RNA large language model [ERNIE-RNA](https://github.com/Bruce-ywj/ERNIE-RNA). You can find more details about SnailBaLL in our paper: [**SnailBaLL: XXXXXXXXXX**]().



</details>

<details><summary>Table of contents</summary>

- [Download SnailBaLL](#Download_SnailBaLL)
- [Setup Environment](#Setup_Environment)
- [Data preparing](#Data_preparing)
- [Extract CLS embedding](#Extract_CLS_embedding)
- [Testing for sequence pairs with known labels](Testing_for_sequence_pairs_with_known_labels)
- [Predict sequence pairs with unknown labels](Predict_sequence_pairs_with_unknown_labels)
- [Citations](#Citations)
- [License](#License)
</details>


## Cuda


## Download SnailBaLL

```
git clone https://github.com/BRUCEBINYE/SnailBaLL.git
cd ./SnailBaLL
```

## Setup environment

SnailBaLL is constructed based on the embeddings of the RNA secondary structure extracted by the RNA large language model ERNIE-RNA ([https://github.com/Bruce-ywj/ERNIE-RNA](https://github.com/Bruce-ywj/ERNIE-RNA)).

Thus, firstly, please build the environment using python 3.9 according to the step "Create Environment with Conda" in the manual of ERNIE-RNA ([https://github.com/Bruce-ywj/ERNIE-RNA](https://github.com/Bruce-ywj/ERNIE-RNA)). Then, please access the pretrained model of ERNIE-RNA according to the step "Access pre-trained models" in its manual. And put the models in each subfolder. For example, here we only use the pretrained model for representation, and only need to put 
"ERNIE-RNA_pretrain.pt" in the subfolder "ERNIE-RNA_checkpoint".

Now, you have create the ERNIR-RNA environment and downloaded the package of ERNIE-RNA containing the pretrained models.

In addition, please make sure to install the following modules in the ERNIR-RNA environment:

```
pip install matplotlib==3.9.4
pip install tensorflow==2.10.0
pip install numpy==1.23.0
```


## Data preparing

The input data could have 3 columns at least: seq1, seq2, and label, which represent the reference sequences,the query sequences, and the label that whether the two taxa is the same genus (1, positive sample) or the different genera (0, negative sample), respectively. You also can add other columns in the dataframe, such as taxa1and taxa2, which represent the reference taxa (genus) and the query taxa (genus), etc. Here, we provide an example dataset containing 100 pairwise sequences with known labels (`./data/example_dataset.txt`).

Because ERNIE-RNA accepts `.fasta` file, or `.txt` file with each sequence in a line, you need to convert the input sequences to input files of ERNIE-RNA.

```
python GetErnieRNAInput.py --input ./data/example_dataset.txt \
  --savepath ./input_file/ERNIE_RNA_input_file/example/ \
  --seq1out example_dataset_seq1_input.txt \
  --seq2out example_dataset_seq2_input.txt \
  --seq1fasta example_dataset_seq1_input.fasta \
  --seq2fasta example_dataset_seq2_input.fasta \
  --lbsout example_dataset_labels_input.pth
```

## Extract CLS embedding

Because we only use the CLS embedding generated by ERNIE-RNA, before performing the embedding extraction, we'd better to edit the `extract_embedding.py` in ERNIE-RNA folder in order not to generate "all embedding" and "attention map". To do so, you need to print `#`s at the head of line 165-171 in original `extract_embedding.py`. **This will significantly reduce the running time and save the disk space for generating only CLS embedding**.

```
cd ./ERNIE-RNA

python extract_embedding.py \
  --seqs_path='../input_file/ERNIE_RNA_input_file/example/example_dataset_seq1_input.txt' \
  --save_path='./results/ernie_rna_representations/example/example_dataset_seq1/' \
  --device=0

python extract_embedding.py \
  --seqs_path='../input_file/ERNIE_RNA_input_file/example/example_dataset_seq2_input.txt' \
  --save_path='./results/ernie_rna_representations/example/example_dataset_seq2/' \
  --device=0
```

## Testing for sequence pairs with known labels

After extracting the CLS embedding of the reference sequences (seq1) and the query sequences (seq2), you can use our pre-trained models based on the 4 subgroups of training sets to perform genus-level prediction.

```
cd ../

python testing.py \
  --seq1_dir "./ERNIE-RNA/results/ernie_rna_representations/example/example_dataset_seq1/cls_embedding.npy" \
  --seq2_dir "./ERNIE-RNA/results/ernie_rna_representations/example/example_dataset_seq2/cls_embedding.npy" \
  --lbs_dir "./input_file/ERNIE_RNA_input_file/example/example_dataset_labels_input.pth" \
  --name "example_dataset" \
  --device 0 \
  --batch True
```



## Predict sequence pairs with unknown labels

If you have sequence pairs that need to predict whether the two sequences are the same genus:

```
python prediction.py \
    --seq1_dir "./ERNIE-RNA/results/ernie_rna_representations/example/example_dataset_seq1/cls_embedding.npy" \
  --seq2_dir "./ERNIE-RNA/results/ernie_rna_representations/example/example_dataset_seq2/cls_embedding.npy" \
  --name "example_dataset_NoLabel" \
  --device 0 \
  --batch False
```


## Citations

If you use SnailBaLL, please cite our work:

[**SnailBaLL: XXXXXXXXXX**]()

Bin Ye, Junfeng Xia, Min Wu, Satoshi Chiba. SnailBaLL: XXXXXXXXXXXXX. 
